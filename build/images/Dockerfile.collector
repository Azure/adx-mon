FROM golang:1.22 as builder

ADD .. /code
WORKDIR /code

# Required for journal input
RUN apt update && apt install -y libsystemd-dev

RUN CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o ./bin/collector ./cmd/collector

FROM mcr.microsoft.com/cbl-mariner/base/core:2.0

# Required for journal input
RUN tdnf install -y systemd

LABEL org.opencontainers.image.source https://github.com/Azure/adx-mon

COPY --from=builder /code/bin /

ENTRYPOINT ["/collector"]
