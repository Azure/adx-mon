
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../quick-start/">
      
      
        <link rel="next" href="../cookbook/cookbook/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Concepts - ADX-Mon Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#concepts" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ADX-Mon Documentation" class="md-header__button md-logo" aria-label="ADX-Mon Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ADX-Mon Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Concepts
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="cyan"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
  
  Docs Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Concepts

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../cookbook/cookbook/" class="md-tabs__link">
          
  
  
  Cookbooks

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../config/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../designs/log-integration-with-kubernetes/" class="md-tabs__link">
          
  
  
  Designs

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ADX-Mon Documentation" class="md-nav__button md-logo" aria-label="ADX-Mon Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ADX-Mon Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Docs Home
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Docs Home
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Components
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#collector" class="md-nav__link">
    <span class="md-ellipsis">
      
        Collector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Collector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration &amp; Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-collector-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Collector CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-config-snippet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Config Snippet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      
        How It Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development &amp; Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingestor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ingestor
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ingestor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-usage_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration &amp; Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-ingestor-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Ingestor CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        How It Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-data-flow-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Data Flow Diagram
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#health-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Health &amp; Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development &amp; Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summaryrules" class="md-nav__link">
    <span class="md-ellipsis">
      
        SummaryRules
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SummaryRules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-usage_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration &amp; Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-summaryrule-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example SummaryRule CRD
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wal-segment-file-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        WAL Segment File Format
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WAL Segment File Format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#segment-file-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Segment File Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Segment File Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#block-layout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Block Layout
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Block Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#block-data-after-decompression" class="md-nav__link">
    <span class="md-ellipsis">
      
        Block Data (after decompression)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-write-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Block Write Example
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versioning-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      
        Versioning &amp; Compatibility
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-repair" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recovery &amp; Repair
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary Table
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-minimal-wal-segment-hex" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example: Minimal WAL Segment (Hex)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alerter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alerter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Alerter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-usage_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration &amp; Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-alerter-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Alerter CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alert-notification-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alert Notification Format
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        How It Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tag-based-routing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tag-Based Routing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unified-execution-selection-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unified Execution Selection Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-cli-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example CLI Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#health-metrics_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Health &amp; Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development &amp; Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adx-exporter" class="md-nav__link">
    <span class="md-ellipsis">
      
        ADX Exporter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ADX Exporter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-usage_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration &amp; Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-cli-usage_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example CLI Usage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-metricsexporter-crd" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example MetricsExporter CRD
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        How It Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transform-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transform Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#health-metrics_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Health &amp; Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development &amp; Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Responsibilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        How It Works
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-operator-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Operator Workflow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-crds" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example CRDs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#federation-multi-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Federation &amp; Multi-Cluster
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development &amp; Testing
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-data-explorer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Azure Data Explorer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grafana" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grafana
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#telemetry" class="md-nav__link">
    <span class="md-ellipsis">
      
        Telemetry
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Telemetry">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traces" class="md-nav__link">
    <span class="md-ellipsis">
      
        Traces
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#continuous-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Continuous Profiling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alerts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Alerts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cookbooks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cookbooks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cookbook/cookbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cookbook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cookbook/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sending Traces With Logs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Collector Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ingestor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ingestor Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adxcluster-controller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADXCluster Controller
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Designs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Designs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../designs/log-integration-with-kubernetes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Log Integration with Kubernetes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../designs/schema-etl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Schema ETL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="concepts">Concepts</h1>
<h2 id="overview">Overview</h2>
<p>ADX-Mon is a fully managed observability solution that supports metrics, logs and traces in a unified stack.
The entrypoint to ADX-Mon is the <code>collector</code> which is deployed as a daemonset in your Kubernetes cluster.</p>
<p>The collector is responsible for collecting metrics, logs and traces from your Kubernetes cluster and sending
them to the <code>ingestor</code> endpoint which handles the ingestion of data into Azure Data Explorer (ADX).</p>
<p>All collected data is translated to ADX tables.  Each table has a consistent schema that can be extended through
<a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/management/updatepolicy"><code>update policies</code></a> to pull
commonly used labels and attributes up to top level columns.</p>
<p>These tables are all queried with <a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/">KQL</a>.  KQL
queries are used for analysis, alerting and visualization.</p>
<h2 id="components">Components</h2>
<h3 id="collector">Collector</h3>
<p>The <strong>Collector</strong> is the entrypoint for telemetry collection in ADX-Mon. It is typically deployed as a DaemonSet on every node in your Kubernetes cluster, where it collects metrics, logs, and traces from the local node and forwards them to the Ingestor for aggregation and storage in Azure Data Explorer (ADX).</p>
<h4 id="key-features">Key Features</h4>
<ul>
<li><strong>Multi-Source Telemetry Collection:</strong> Collects from Prometheus endpoints, logs (including OTLP and host logs), and traces.</li>
<li><strong>Kubernetes Native:</strong> Discovers pods and services to scrape via annotations (e.g., <code>adx-mon/scrape: "true"</code>).</li>
<li><strong>Configurable via TOML:</strong> Uses a TOML config file (see <code>docs/config.md</code>) for flexible setup of scrape targets, filters, exporters, and storage.</li>
<li><strong>Efficient Buffering:</strong> Uses a Write-Ahead Log (WAL) to buffer data locally for reliability and performance.</li>
<li><strong>Label/Attribute Lifting:</strong> Supports lifting selected labels/attributes to top-level columns for easier querying in ADX.</li>
<li><strong>Filtering:</strong> Supports regex-based keep/drop rules for metrics and labels, and attribute-based log filtering.</li>
<li><strong>Exporters:</strong> Can forward telemetry to additional endpoints (e.g., OTLP, Prometheus remote write) in parallel with ADX.</li>
<li><strong>Health &amp; Metrics:</strong> Exposes Prometheus metrics for collector health, WAL status, and scrape/export stats.</li>
</ul>
<h4 id="configuration-usage">Configuration &amp; Usage</h4>
<ul>
<li><strong>Deployment:</strong> Usually managed by the adx-mon Operator via the <code>Collector</code> CRD, or deployed as a DaemonSet.</li>
<li><strong>Config File:</strong> Main configuration is via a TOML file (see <code>docs/config.md</code> for all options and examples). Key fields include:</li>
<li><code>endpoint</code>: Ingestor URL to send telemetry to.</li>
<li><code>storage-dir</code>: Directory for WAL and log cursors.</li>
<li><code>prometheus-scrape</code>: Prometheus scrape settings (interval, targets, filters).</li>
<li><code>prometheus-remote-write</code>: Accepts Prometheus remote write protocol.</li>
<li><code>otel-log</code>/<code>otel-metric</code>: Accepts OTLP logs/metrics.</li>
<li><code>host-log</code>: Collects host and kernel logs.</li>
<li><code>exporters</code>: Additional telemetry destinations.</li>
<li><strong>Kubernetes Annotations:</strong></li>
<li><code>adx-mon/scrape</code>: Enables scraping for a pod/service.</li>
<li><code>adx-mon/port</code>, <code>adx-mon/path</code>: Configure scrape port/path. Port can be numeric (e.g., "8080") or named (e.g., "metrics").</li>
<li><code>adx-mon/targets</code>: Comma-separated list of path:port combinations. Supports named ports.</li>
<li><code>adx-mon/log-destination</code>: Sets log destination table.</li>
<li><code>adx-mon/log-parsers</code>: Comma-separated list of log parsers (e.g., <code>json</code>).</li>
</ul>
<h4 id="example-collector-crd">Example Collector CRD</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Collector</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-collector</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ghcr.io/azure/adx-mon/collector:v1.0.0&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="nt">ingestorEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://prod-ingestor.monitoring.svc.cluster.local:8080&quot;</span>
</code></pre></div>
<h4 id="example-config-snippet">Example Config Snippet</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;https://ingestor.adx-mon.svc.cluster.local&#39;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">storage-dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/var/lib/adx-mon&#39;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;eastus&#39;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">[prometheus-scrape]</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Metrics&#39;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">  </span><span class="n">scrape-interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">  </span><span class="n">scrape-timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span><span class="n">drop-metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;^kube_pod_ips$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;etcd_grpc.*&#39;</span><span class="p">]</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="n">keep-metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;nginx.*&#39;</span><span class="p">]</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="k">[[prometheus-scrape.static-scrape-target]]</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">  </span><span class="n">host-regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;.*&#39;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://localhost:9090/metrics&#39;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">  </span><span class="n">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;monitoring&#39;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">  </span><span class="n">pod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host-monitor&#39;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">  </span><span class="n">container</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host-monitor&#39;</span>
</code></pre></div>
<h4 id="how-it-works">How It Works</h4>
<ol>
<li><strong>Discovery:</strong> Finds pods/services to scrape based on annotations and static config.</li>
<li><strong>Scraping/Collection:</strong> Collects metrics, logs, and traces from configured sources.</li>
<li><strong>Buffering:</strong> Writes data to local WAL for reliability and batching.</li>
<li><strong>Forwarding:</strong> Sends batches to the Ingestor, which aggregates and uploads to ADX.</li>
<li><strong>Exporting:</strong> Optionally forwards telemetry to additional endpoints (e.g., OTLP, remote write).</li>
<li><strong>Health Monitoring:</strong> Exposes <code>/metrics</code> for Prometheus scraping and tracks WAL/export status.</li>
</ol>
<h4 id="development-testing">Development &amp; Testing</h4>
<ul>
<li>Configurable for local or in-cluster testing.</li>
<li>See <code>docs/config.md</code> for all config options and advanced usage.</li>
</ul>
<hr />
<h3 id="ingestor">Ingestor</h3>
<p>The <strong>Ingestor</strong> is the aggregation and buffering point for all telemetry collected by ADX-Mon. It receives metrics, logs, and traces from Collectors, batches and stores them using a Write-Ahead Log (WAL), and uploads them to Azure Data Explorer (ADX) in optimized batches. The ingestor is designed for high-throughput, reliability, and efficient use of ADX resources.</p>
<h4 id="key-features_1">Key Features</h4>
<ul>
<li><strong>WAL-Based Buffering:</strong> All incoming telemetry is written to disk in an append-only WAL for durability and efficient batching.</li>
<li><strong>Batching &amp; Coalescing:</strong> Segments are batched by table/schema and uploaded to ADX in large, compressed batches (100MBâ€“1GB recommended) to optimize ingestion cost and performance.</li>
<li><strong>Peer Transfer:</strong> Small segments are transferred to peer ingestors for coalescing, reducing the number of small files ingested by ADX.</li>
<li><strong>Direct Upload Fallback:</strong> If a segment is too old or too large, it is uploaded directly to ADX, bypassing peer transfer.</li>
<li><strong>Multi-Database Support:</strong> Can upload to multiple ADX databases (e.g., metrics, logs) simultaneously.</li>
<li><strong>Kubernetes Native:</strong> Deployed as a StatefulSet, supports scaling and partitioning.</li>
<li><strong>CRD-Driven:</strong> Managed via the <code>Ingestor</code> CRD for declarative configuration.</li>
<li><strong>Health &amp; Metrics:</strong> Exposes Prometheus metrics for WAL, batching, upload, and transfer status.</li>
</ul>
<h4 id="configuration-usage_1">Configuration &amp; Usage</h4>
<ul>
<li><strong>Deployment:</strong> Usually managed by the adx-mon Operator via the <code>Ingestor</code> CRD, or deployed as a StatefulSet.</li>
<li><strong>Config File/CLI:</strong> Main configuration is via CLI flags or environment variables (see <code>cmd/ingestor/main.go</code>). Key options include:</li>
<li><code>--storage-dir</code>: Directory for WAL segments.</li>
<li><code>--metrics-kusto-endpoints</code>, <code>--logs-kusto-endpoints</code>: ADX endpoints for metrics/logs (format: <code>&lt;db&gt;=&lt;endpoint&gt;</code>).</li>
<li><code>--cluster-labels</code>: Labels used to identify and distinguish ingestor clusters (format: <code>&lt;key&gt;=&lt;value&gt;</code>). Used for <code>&lt;key&gt;</code> substitutions in SummaryRules.</li>
<li><code>--uploads</code>: Number of concurrent uploads.</li>
<li><code>--max-segment-size</code>, <code>--max-segment-age</code>: Segment batching thresholds.</li>
<li><code>--max-transfer-size</code>, <code>--max-transfer-age</code>: Peer transfer thresholds.</li>
<li><code>--disable-peer-transfer</code>: Disable peer transfer (upload all segments directly).</li>
<li><code>--partition-size</code>: Number of nodes in a partition for sharding.</li>
<li><code>--max-disk-usage</code>, <code>--max-segment-count</code>: Backpressure controls.</li>
<li><code>--enable-wal-fsync</code>: Enable fsync for WAL durability.</li>
<li>See <code>docs/config.md</code> for all options.</li>
</ul>
<h4 id="example-ingestor-crd">Example Ingestor CRD</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingestor</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-ingestor</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ghcr.io/azure/adx-mon/ingestor:v1.0.0&quot;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://prod-ingestor.monitoring.svc.cluster.local:8080&quot;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">  </span><span class="nt">exposeExternally</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">  </span><span class="nt">adxClusterSelector</span><span class="p">:</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon</span>
</code></pre></div>
<h4 id="how-it-works_1">How It Works</h4>
<ol>
<li><strong>Receive Telemetry:</strong> Collectors send metrics/logs/traces to the ingestor via HTTP (Prometheus remote write, OTLP, etc.).</li>
<li><strong>WAL Write:</strong> Data is written to a WAL segment file per table/schema.</li>
<li><strong>Batching:</strong> When a segment reaches the max size or age, it is either:</li>
<li><strong>Transferred to a peer</strong> (if small enough and within age threshold), or</li>
<li><strong>Uploaded directly to ADX</strong> (if too large/old or transfer fails).</li>
<li><strong>Peer Transfer:</strong> Segments are transferred to the peer responsible for the table (partitioned by hash). Peers coalesce segments for larger uploads.</li>
<li><strong>ADX Upload:</strong> Batches are compressed and uploaded to ADX using the Kusto ingestion API. Table and mapping are auto-managed.</li>
<li><strong>Cleanup:</strong> Uploaded/expired segments are removed from disk. Backpressure is applied if disk usage/segment count exceeds limits.</li>
</ol>
<h4 id="example-data-flow-diagram">Example Data Flow Diagram</h4>
<pre class="mermaid"><code>flowchart TD
    Collector1 --&gt;|metrics/logs| IngestorA
    Collector2 --&gt;|metrics/logs| IngestorB
    IngestorA -- Peer Transfer --&gt; IngestorB
    IngestorA -- Upload --&gt; ADX[(Azure Data Explorer)]
    IngestorB -- Upload --&gt; ADX</code></pre>
<h4 id="health-metrics">Health &amp; Metrics</h4>
<ul>
<li>Exposes <code>/metrics</code> endpoint for Prometheus scraping.</li>
<li>Tracks WAL segment counts, disk usage, upload/transfer queue sizes, upload/transfer rates, and error counts.</li>
<li>Provides metrics for backpressure, slow requests, and dropped segments.</li>
</ul>
<h4 id="development-testing_1">Development &amp; Testing</h4>
<ul>
<li>Can be run locally with test ADX clusters or in "direct upload" mode.</li>
<li>Includes integration tests for WAL, batching, and upload logic.</li>
<li>See <code>docs/ingestor.md</code> and <code>README.md</code> for advanced usage and troubleshooting.</li>
</ul>
<hr />
<h3 id="summaryrules">SummaryRules</h3>
<p><strong>SummaryRules</strong> provide automated data aggregation and ETL (Extract, Transform, Load) capabilities within ADX-Mon. They execute scheduled KQL queries against ADX to create rollups, downsampled data, or import data from external sources, helping manage data retention costs and improve query performance.</p>
<h4 id="key-features_2">Key Features</h4>
<ul>
<li><strong>Automated Scheduling:</strong> Execute KQL queries at defined intervals (e.g., hourly, daily) with precise time window management.</li>
<li><strong>Async Operation Tracking:</strong> Submit queries as ADX async operations and monitor them through completion, handling retries and failures automatically.</li>
<li><strong>Time Window Management:</strong> Calculate exact execution windows to ensure no data gaps or overlaps between runs.</li>
<li><strong>Cluster Label Substitution:</strong> Support environment-agnostic rules using cluster labels for multi-environment deployments.</li>
<li><strong>State Persistence:</strong> Track execution history and operation status using Kubernetes conditions.</li>
<li><strong>Resilient Operation:</strong> Handle ADX cluster restarts, network issues, and operation cleanup automatically.</li>
</ul>
<h4 id="configuration-usage_2">Configuration &amp; Usage</h4>
<ul>
<li><strong>Deployment:</strong> SummaryRules are managed by the Ingestor's <code>SummaryRuleTask</code> which runs periodically to process all rules.</li>
<li><strong>CRD Definition:</strong> Rules are defined as <code>SummaryRule</code> CRDs with fields:</li>
<li><code>database</code>: Target ADX database</li>
<li><code>table</code>: Destination table for aggregated results</li>
<li><code>body</code>: KQL query with <code>_startTime</code> and <code>_endTime</code> placeholders</li>
<li><code>interval</code>: Execution frequency (e.g., <code>1h</code>, <code>15m</code>, <code>1d</code>)</li>
<li><strong>Placeholders:</strong></li>
<li><code>_startTime</code>/<code>_endTime</code>: Automatically replaced with execution window times</li>
<li><code>_&lt;label&gt;</code>: Replaced with cluster label values from ingestor configuration</li>
</ul>
<h4 id="example-summaryrule-crd">Example SummaryRule CRD</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SummaryRule</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hourly-cpu-usage</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Metrics</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CPUUsageHourly</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">  </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">  </span><span class="nt">body</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="no">Metrics</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="no">| where Timestamp between (_startTime .. _endTime)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="no">| where Name == &quot;cpu_usage_percent&quot;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="no">| summarize avg(Value), max(Value), min(Value)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">      </span><span class="no">by bin(Timestamp, 1h), Pod, Namespace</span>
</code></pre></div>
<p>For detailed examples and best practices, see the <a href="../cookbook/cookbook/#summaryrules">SummaryRules Cookbook</a>.</p>
<hr />
<h2 id="wal-segment-file-format">WAL Segment File Format</h2>
<blockquote>
<p><strong>Note:</strong> The WAL binary format is fully documented below and matches the implementation in <code>pkg/wal/segment.go</code>. This includes segment and block headers, field layout, encoding, versioning, and repair logic. For advanced integrations or troubleshooting, see also <a href="../ingestor/#wal-format-and-storage">Ingestor Overview</a>.</p>
</blockquote>
<p>WAL (Write-Ahead Log) segment files are the durable, append-only storage format used for buffering telemetry data before upload to Azure Data Explorer (ADX). Understanding the binary format is essential for troubleshooting, recovery, and advanced integrations.</p>
<h3 id="segment-file-structure">Segment File Structure</h3>
<p>Each WAL segment file consists of:</p>
<ol>
<li><strong>Segment Header (8 bytes):</strong></li>
<li>Bytes 0-5: ASCII <code>"ADXWAL"</code> (magic number)</li>
<li>
<p>Bytes 6-7: Reserved for future use (e.g., versioning)</p>
</li>
<li>
<p><strong>Block Sequence:</strong></p>
</li>
<li>The remainder of the file is a sequence of blocks, each with its own header and compressed payload.</li>
</ol>
<h4 id="block-layout">Block Layout</h4>
<p>Each block is encoded as:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Length</td>
<td>4 bytes</td>
<td>Big-endian uint32: length of the compressed block</td>
</tr>
<tr>
<td>CRC32</td>
<td>4 bytes</td>
<td>Big-endian uint32: CRC32 checksum of the compressed block</td>
</tr>
<tr>
<td>Block Data</td>
<td>variable</td>
<td>S2 (Snappy-compatible) compressed block (see below)</td>
</tr>
</tbody>
</table>
<h5 id="block-data-after-decompression">Block Data (after decompression)</h5>
<table>
<thead>
<tr>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Magic</td>
<td>2 bytes</td>
<td><code>0xAA 0xAA</code> (block header magic number)</td>
</tr>
<tr>
<td>Version</td>
<td>1 byte</td>
<td>Block version (currently <code>1</code>)</td>
</tr>
<tr>
<td>Type</td>
<td>1 byte</td>
<td>Sample type (e.g., metric, log, trace)</td>
</tr>
<tr>
<td>Count</td>
<td>4 bytes</td>
<td>Big-endian uint32: number of samples in the block</td>
</tr>
<tr>
<td>Value</td>
<td>N bytes</td>
<td>Actual uncompressed data payload</td>
</tr>
</tbody>
</table>
<ul>
<li>The block data is compressed using S2 (Snappy-compatible) before being written to disk.</li>
<li>The block header (magic, version, type, count) is always present at the start of the decompressed block.</li>
</ul>
<h5 id="block-write-example">Block Write Example</h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>â”‚    Len    â”‚   CRC   â”‚   Magic   â”‚  Version  â”‚   Type    â”‚   Count   â”‚   Value   â”‚
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>â”‚  4 bytes  â”‚ 4 bytes â”‚  2 bytes  â”‚  1 byte   â”‚  1 byte   â”‚  4 bytes  â”‚  N bytes  â”‚
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<h3 id="versioning-compatibility">Versioning &amp; Compatibility</h3>
<ul>
<li>The segment version is stored in the block header (currently <code>1</code>).</li>
<li>The first 8 bytes of the file are reserved for magic/versioning.</li>
<li>The format is designed for forward compatibility; unknown blocks can be skipped or truncated.</li>
</ul>
<h3 id="recovery-repair">Recovery &amp; Repair</h3>
<ul>
<li>Each block is independently verifiable using its CRC32 checksum.</li>
<li>The <code>Repair()</code> method can truncate the file at the last good block if corruption is detected (e.g., after a crash).</li>
</ul>
<h3 id="summary-table">Summary Table</h3>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>SegmentMagic</td>
<td>8 bytes</td>
<td><code>"ADXWAL"</code> + reserved</td>
</tr>
<tr>
<td>8+</td>
<td>Block(s)</td>
<td>variable</td>
<td>See block structure above</td>
</tr>
</tbody>
</table>
<h3 id="example-minimal-wal-segment-hex">Example: Minimal WAL Segment (Hex)</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>41 44 58 57 41 4C 00 00   # &quot;ADXWAL&quot; + reserved
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>...                       # Block(s) as described above
</code></pre></div>
<hr />
<p>For more details, see the implementation in <code>pkg/wal/segment.go</code> and <code>pkg/wal/wal.go</code>.</p>
<hr />
<h3 id="alerter">Alerter</h3>
<p>The <strong>Alerter</strong> component is responsible for evaluating alert rules (defined as Kubernetes <code>AlertRule</code> CRDs) and sending alert notifications to external systems when conditions are met. It queries Azure Data Explorer (ADX) on a schedule, evaluates the results, and generates notifications for each alerting row.</p>
<h4 id="key-features_3">Key Features</h4>
<ul>
<li><strong>CRD-Driven:</strong> Alerting rules are defined as <code>AlertRule</code> CRDs, specifying the KQL query, schedule, and notification destination.</li>
<li><strong>Kusto Query Execution:</strong> Periodically executes KQL queries against ADX clusters, as configured in the rule.</li>
<li><strong>Notification Delivery:</strong> Sends alert notifications to a configurable HTTP endpoint (e.g., ICM, PagerDuty, custom webhooks) in a standard JSON format.</li>
<li><strong>Correlation &amp; Auto-Mitigation:</strong> Supports correlation IDs to deduplicate alerts and auto-mitigate after a configurable duration.</li>
<li><strong>Tag-Based Routing:</strong> Supports tag-based filtering to control which alerter instance processes which rules (e.g., by region, cloud, or custom tags).</li>
<li><strong>Conditional Execution (criteria / criteriaExpression):</strong> AlertRule, SummaryRule and MetricsExporter share unified conditional logic. A legacy <code>criteria</code> map (OR semantics across entries) and an optional CEL <code>criteriaExpression</code> (evaluated against lowerâ€‘cased cluster label/tag variables such as <code>region</code>, <code>cloud</code>, <code>environment</code>, etc.) combine with AND semantics. If either is empty it is permissive. Evaluation errors skip execution.</li>
<li><strong>Health &amp; Metrics:</strong> Exposes Prometheus metrics for alert delivery health, query health, and notification status.</li>
</ul>
<h4 id="configuration-usage_3">Configuration &amp; Usage</h4>
<ul>
<li><strong>Deployment:</strong> The alerter is typically deployed as a Kubernetes Deployment or managed by the adx-mon Operator via the <code>Alerter</code> CRD.</li>
<li><strong>Configurable via CLI:</strong> Supports configuration via command-line flags (see <code>cmd/alerter/main.go</code>), including Kusto endpoints, region, cloud, notification endpoint, concurrency, and tags.</li>
<li><strong>Notification Endpoint:</strong> Set via the <code>notificationEndpoint</code> field in the <code>Alerter</code> CRD or <code>--alerter-address</code> CLI flag. This is the HTTP endpoint to which alert notifications are POSTed.</li>
<li><strong>Kusto Endpoints:</strong> Provided as a map of database name to endpoint (e.g., <code>--kusto-endpoint "DB=https://cluster.kusto.windows.net"</code>).</li>
<li><strong>Tags:</strong> Key-value pairs (e.g., <code>--tag region=uksouth</code>) used to filter which rules this alerter instance will process.</li>
</ul>
<h4 id="example-alerter-crd">Example Alerter CRD</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alerter</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-alerter</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ghcr.io/azure/adx-mon/alerter:v1.0.0&quot;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="nt">notificationEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://alerter-endpoint&quot;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="nt">adxClusterSelector</span><span class="p">:</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon</span>
</code></pre></div>
<h4 id="alert-notification-format">Alert Notification Format</h4>
<p>Alert notifications are sent as JSON via HTTP POST to the configured endpoint. Example payload:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="nt">&quot;Destination&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;MDM://Platform&quot;</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="nt">&quot;Title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;High CPU Usage&quot;</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="nt">&quot;Summary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CPU usage exceeded 90% on node xyz&quot;</span><span class="p">,</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="nt">&quot;Description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The CPU usage on node xyz has been above 90% for 5 minutes.&quot;</span><span class="p">,</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="nt">&quot;Severity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="nt">&quot;Source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;namespace/alert-name&quot;</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">  </span><span class="nt">&quot;CorrelationID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;namespace/alert-name://unique-correlation-id&quot;</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">  </span><span class="nt">&quot;CustomFields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uksouth&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="how-it-works_2">How It Works</h4>
<ol>
<li><strong>Rule Discovery:</strong> Loads <code>AlertRule</code> CRDs from the Kubernetes API or local files.</li>
<li><strong>Query Execution:</strong> On each interval, executes the KQL query defined in the rule against the specified ADX database.</li>
<li><strong>Result Processing:</strong> For each row returned, constructs an alert notification, including severity, title, summary, correlation ID, and custom fields.</li>
<li><strong>Notification Delivery:</strong> Sends the alert as a JSON payload to the configured notification endpoint.</li>
<li><strong>Health Monitoring:</strong> Exposes Prometheus metrics for query and notification health.</li>
</ol>
<h4 id="tag-based-routing">Tag-Based Routing</h4>
<p>Alerter instances can be configured with tags (e.g., <code>region</code>, <code>cloud</code>). Only rules whose <code>criteria</code> match the instance's tags will be processed by that instance. This enables multi-region or multi-cloud deployments. <code>criteriaExpression</code> is parsed and executed using <a href="https://cel.dev/">CEL</a>, with the available variables being defined by tags passed into the executing service.</p>
<h4 id="unified-execution-selection-examples">Unified Execution Selection Examples</h4>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Map only</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nt">criteria</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">eastus</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">westus</span><span class="p p-Indicator">]</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="c1"># Expression only</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="nt">criteriaExpression</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">region in [&#39;eastus&#39;,&#39;westus&#39;] &amp;&amp; env == &#39;prod&#39;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="c1"># Both (AND)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span><span class="nt">criteria</span><span class="p">:</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">eastus</span><span class="p p-Indicator">]</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span><span class="nt">criteriaExpression</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">env == &#39;prod&#39; &amp;&amp; cloud == &#39;public&#39;</span>
</code></pre></div>
Behavior formula: <code>(criteria empty OR any match) AND (criteriaExpression empty OR expression true)</code>.</p>
<h4 id="example-cli-usage">Example CLI Usage</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nb">cd</span><span class="w"> </span>cmd/alerter
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="c1"># Run with required Kusto endpoint and kubeconfig</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>./alerter<span class="w"> </span>--kusto-endpoint<span class="w"> </span><span class="s2">&quot;DB=https://cluster.kusto.windows.net&quot;</span><span class="w"> </span>--kubeconfig<span class="w"> </span>~/.kube/config<span class="w"> </span>--region<span class="w"> </span>uksouth<span class="w"> </span>--cloud<span class="w"> </span>AzureCloud<span class="w"> </span>--tag<span class="w"> </span><span class="nv">environment</span><span class="o">=</span><span class="nb">test</span><span class="w"> </span>--alerter-address<span class="w"> </span>http://alerter-endpoint
</code></pre></div>
<h4 id="health-metrics_1">Health &amp; Metrics</h4>
<ul>
<li>Exposes <code>/metrics</code> endpoint for Prometheus scraping.</li>
<li>Tracks health of query execution and notification delivery.</li>
<li>Provides metrics for alert delivery failures, unhealthy rules, and notification status.</li>
</ul>
<h4 id="development-testing_2">Development &amp; Testing</h4>
<ul>
<li>Includes a <code>lint</code> mode to validate alert rules without sending notifications.</li>
<li>Supports local testing with fake Kusto and alert endpoints.</li>
<li>See <code>README.md</code> for testing instructions.</li>
</ul>
<hr />
<h3 id="adx-exporter">ADX Exporter</h3>
<p>The <strong>ADX Exporter</strong> (<code>adxexporter</code>) component executes KQL queries against Azure Data Explorer and exports the results as metrics to OTLP-compatible endpoints. It enables organizations to transform ADX analytics data into standardized metrics for external observability platforms without creating intermediate ADX tables.</p>
<h4 id="key-features_4">Key Features</h4>
<ul>
<li><strong>Direct KQL Execution:</strong> Execute KQL queries and transform results to metrics without intermediate table storage.</li>
<li><strong>OTLP Push:</strong> Push metrics directly to any OTLP-compatible endpoint (OpenTelemetry Collector, Prometheus with remote-write receiver, etc.).</li>
<li><strong>Memory Efficient:</strong> Uses <code>pkg/prompb</code> object pooling for high cardinality metrics with reduced GC pressure.</li>
<li><strong>Timestamp Fidelity:</strong> Preserves actual KQL query timestamps instead of export-time timestamps.</li>
<li><strong>Criteria-Based Execution:</strong> Supports the same cluster-label filtering as Alerter and SummaryRules for secure, distributed execution.</li>
<li><strong>CRD-Driven:</strong> MetricsExporter CRDs define KQL queries, transform configuration, and scheduling.</li>
</ul>
<h4 id="configuration-usage_4">Configuration &amp; Usage</h4>
<ul>
<li><strong>Deployment:</strong> Deploy as a standalone Kubernetes Deployment with appropriate cluster labels.</li>
<li><strong>CLI Flags:</strong></li>
<li><code>--cluster-labels</code>: Comma-separated key=value pairs for criteria matching (e.g., <code>region=eastus,environment=production</code>).</li>
<li><code>--kusto-endpoint</code>: ADX endpoint in format <code>&lt;database&gt;=&lt;endpoint&gt;</code>. Can specify multiple.</li>
<li><code>--otlp-endpoint</code>: <strong>(Required)</strong> OTLP HTTP endpoint for pushing metrics.</li>
<li><code>--health-probe-port</code>: Port for health endpoints (default: 8081).</li>
</ul>
<h4 id="example-cli-usage_1">Example CLI Usage</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>adxexporter<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span>--cluster-labels<span class="o">=</span><span class="s2">&quot;region=eastus,environment=production,team=platform&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span>--kusto-endpoint<span class="o">=</span><span class="s2">&quot;MetricsDB=https://cluster.kusto.windows.net&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span>--otlp-endpoint<span class="o">=</span><span class="s2">&quot;http://otel-collector:4318/v1/metrics&quot;</span>
</code></pre></div>
<h4 id="example-metricsexporter-crd">Example MetricsExporter CRD</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MetricsExporter</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service-response-times</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TelemetryDB</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">  </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">  </span><span class="nt">criteria</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;eastus&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;westus&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;production&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">  </span><span class="nt">body</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">    </span><span class="no">ServiceTelemetry</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">    </span><span class="no">| where Timestamp between (_startTime .. _endTime)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">    </span><span class="no">| summarize </span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="no">metric_value = avg(ResponseTimeMs),</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span><span class="no">timestamp = bin(Timestamp, 1m)</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="no">by ServiceName, Environment</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">    </span><span class="no">| extend metric_name = &quot;service_response_time_avg&quot;</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">  </span><span class="nt">transform</span><span class="p">:</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">    </span><span class="nt">metricNameColumn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;metric_name&quot;</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">    </span><span class="nt">valueColumns</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;metric_value&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">    </span><span class="nt">timestampColumn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;timestamp&quot;</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">    </span><span class="nt">labelColumns</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ServiceName&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;Environment&quot;</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h4 id="how-it-works_3">How It Works</h4>
<ol>
<li><strong>CRD Discovery:</strong> Watches MetricsExporter CRDs matching its cluster labels via criteria filtering.</li>
<li><strong>Query Execution:</strong> Executes KQL queries on schedule with <code>_startTime</code>/<code>_endTime</code> parameter substitution.</li>
<li><strong>Transform:</strong> Converts KQL results to <code>MetricData</code> using the transform configuration.</li>
<li><strong>OTLP Push:</strong> Converts metrics to <code>prompb.WriteRequest</code> format using pooled objects and pushes to the OTLP endpoint.</li>
</ol>
<h4 id="transform-configuration">Transform Configuration</h4>
<p>The transform configuration maps KQL columns to metrics format:
- <code>metricNameColumn</code>: Column containing metric names (or use <code>defaultMetricName</code> for a static name).
- <code>valueColumns</code>: Array of columns containing numeric metric values.
- <code>timestampColumn</code>: Column containing timestamps.
- <code>labelColumns</code>: Columns to use as metric labels/attributes.
- <code>metricNamePrefix</code>: Optional prefix for all metric names.</p>
<h4 id="health-metrics_2">Health &amp; Metrics</h4>
<ul>
<li>Exposes <code>/healthz</code> and <code>/readyz</code> endpoints on the health probe port (default: 8081).</li>
<li>Metrics are pushed to the configured OTLP endpoint, not scraped.</li>
</ul>
<h4 id="development-testing_3">Development &amp; Testing</h4>
<ul>
<li>Supports local testing with mock OTLP endpoints.</li>
<li>See the <a href="../designs/kusto-to-metrics/">Kusto-to-Metrics Design</a> for detailed architecture and implementation.</li>
</ul>
<hr />
<h3 id="operator">Operator</h3>
<p>The <strong>Operator</strong> is the control plane component that manages the lifecycle of all adx-mon resourcesâ€”including Collectors, Ingestors, Alerters, and Azure Data Explorer (ADX) infrastructureâ€”using Kubernetes Custom Resource Definitions (CRDs). It provides a declarative, automated, and production-ready way to deploy, scale, and manage the entire ADX-Mon stack.</p>
<h4 id="key-responsibilities">Key Responsibilities</h4>
<ul>
<li><strong>CRD Management:</strong> Watches and reconciles <code>ADXCluster</code>, <code>Ingestor</code>, <code>Collector</code>, and <code>Alerter</code> CRDs, ensuring the actual state matches the desired state.</li>
<li><strong>Azure Infrastructure Automation:</strong> Provisions and manages ADX clusters and databases using the Azure SDK for Go, including resource groups, managed identities, and database policies.</li>
<li><strong>Component Lifecycle:</strong> Generates and applies Kubernetes manifests for all adx-mon components, supporting custom images, replica counts, and configuration overrides.</li>
<li><strong>Reconciliation &amp; Drift Detection:</strong> Continuously monitors managed resources and reverts manual changes to match the CRD spec. Updates CRD status fields to reflect progress and issues.</li>
<li><strong>Incremental, Granular Workflow:</strong> Proceeds in dependency order (ADX â†’ Ingestor â†’ Collector â†’ Alerter), updating subresource conditions at each phase.</li>
<li><strong>Resource Cleanup:</strong> Deletes managed Kubernetes resources when CRDs are deleted. (Azure resources are not deleted by default.)</li>
<li><strong>Multi-Cluster &amp; Federation:</strong> Supports federated and partitioned ADX topologies for geo-distributed or multi-tenant scenarios.</li>
</ul>
<h4 id="how-it-works_4">How It Works</h4>
<ol>
<li><strong>CRD Reconciliation:</strong> Watches for changes to adx-mon CRDs and managed resources.</li>
<li><strong>Azure Resource Management:</strong> Provisions or connects to ADX clusters/databases as specified in the <code>ADXCluster</code> CRD.</li>
<li><strong>Component Deployment:</strong> Deploys or updates StatefulSets/Deployments for Ingestor, Collector, and Alerter based on their CRDs.</li>
<li><strong>Status &amp; Health:</strong> Updates CRD status fields and subresource conditions to reflect readiness and errors.</li>
<li><strong>Federation Support:</strong> Manages federated clusters, heartbeats, named entity groups, and macro-expand KQL functions for cross-cluster querying.</li>
</ol>
<h4 id="example-operator-workflow">Example Operator Workflow</h4>
<pre class="mermaid"><code>flowchart TD
    ADXClusterCRD --&gt;|provision| ADXCluster
    ADXCluster --&gt;|ready| IngestorCRD
    IngestorCRD --&gt;|deploy| Ingestor
    Ingestor --&gt;|ready| CollectorCRD
    CollectorCRD --&gt;|deploy| Collector
    Collector --&gt;|ready| AlerterCRD
    AlerterCRD --&gt;|deploy| Alerter</code></pre>
<h4 id="example-crds">Example CRDs</h4>
<ul>
<li><strong>ADXCluster:</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ADXCluster</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-adx-cluster</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-metrics</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://prod-metrics.kusto.windows.net&quot;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="nt">provision</span><span class="p">:</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="nt">subscriptionId</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;00000000-0000-0000-0000-000000000000&quot;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;adx-monitor-prod&quot;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;eastus2&quot;</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="nt">skuName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Standard_L8as_v3&quot;</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Standard&quot;</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="nt">managedIdentityClientId</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;11111111-1111-1111-1111-111111111111&quot;</span>
</code></pre></div></li>
<li><strong>Ingestor:</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingestor</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-ingestor</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ghcr.io/azure/adx-mon/ingestor:v1.0.0&quot;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://prod-ingestor.monitoring.svc.cluster.local:8080&quot;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">  </span><span class="nt">exposeExternally</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">  </span><span class="nt">adxClusterSelector</span><span class="p">:</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon</span>
</code></pre></div></li>
<li><strong>Collector:</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Collector</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-collector</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ghcr.io/azure/adx-mon/collector:v1.0.0&quot;</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">  </span><span class="nt">ingestorEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://prod-ingestor.monitoring.svc.cluster.local:8080&quot;</span>
</code></pre></div></li>
<li><strong>Alerter:</strong>
  <div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alerter</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-alerter</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ghcr.io/azure/adx-mon/alerter:v1.0.0&quot;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">  </span><span class="nt">notificationEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://alerter-endpoint&quot;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">  </span><span class="nt">adxClusterSelector</span><span class="p">:</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon</span>
</code></pre></div></li>
</ul>
<h4 id="federation-multi-cluster">Federation &amp; Multi-Cluster</h4>
<ul>
<li><strong>Partition Clusters:</strong> Each partition cluster is managed by its own operator and contains a subset of the data (e.g., by geo or tenant).</li>
<li><strong>Federated Cluster:</strong> A central operator manages a federated ADX cluster, providing a unified query interface and managing heartbeats, named entity groups, and macro-expand KQL functions.</li>
<li><strong>Heartbeat Table:</strong> Partition clusters send periodic heartbeats to the federated cluster, which uses them to discover topology and liveness.</li>
<li><strong>Named Entity Groups:</strong> The federated operator creates named entity groups (e.g., <code>MetricsSpoke</code>, <code>LogsSpoke</code>) that reference all partition cluster endpoints for each database, enabling efficient cross-cluster querying via macro-expand.</li>
</ul>
<h4 id="development-testing_4">Development &amp; Testing</h4>
<ul>
<li>Operator can be run locally or in-cluster.</li>
<li>Supports dry-run and debug modes for safe testing.</li>
<li>See <code>docs/designs/operator.md</code> for advanced configuration, federation, and troubleshooting.</li>
</ul>
<hr />
<h3 id="azure-data-explorer">Azure Data Explorer</h3>
<h3 id="grafana">Grafana</h3>
<h2 id="telemetry">Telemetry</h2>
<h3 id="metrics">Metrics</h3>
<p>Metrics track a numeric value over time with associated labels to identify series.  Metrics are collected from
Kubernetes via the <a href="https://prometheus.io/">Prometheus</a> scrape protocol as well as received via prometheus
remote write protocol and <a href="https://opentelemetry.io/docs/specs/otlp/">OTLP</a> metrics protocol.</p>
<p>Metrics are translated to a distinct table per metric.  Each metric table has the following columns:</p>
<ul>
<li><code>Timestamp</code> - The timestamp of the metric.</li>
<li><code>Value</code> - The value of the metric.</li>
<li><code>Labels</code> - A dynamic column that contains all labels associated with the metric.</li>
<li><code>SeriesId</code> - A unique ID for the metric series that comprises the <code>Labels</code> and metric name.</li>
</ul>
<p>Labels may have common identifying attributes that can be pulled up to top level columns via update policies.  For
example, the <code>pod</code> label may be common to all metrics and can be pulled up to a top level <code>Pod</code> column.</p>
<h3 id="logs">Logs</h3>
<p>Logs are ingested into ADX as <a href="https://opentelemetry.io/docs/specs/otel/logs/data-model/#log-and-event-record-definition">OTLP</a> records. You can define custom table schemas through a Kubernetes CRD called <code>Function</code>, which represents an <a href="https://learn.microsoft.com/en-us/kusto/query/schema-entities/views?view=microsoft-fabric">ADX View</a>. This allows you to present log events in a custom format rather than querying the OTLP structure directly. Below is an example of specifying a custom schema for the Ingestor component:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Function</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingestor-view</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">  </span><span class="nt">body</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="no">.create-or-alter function with (view=true, folder=&#39;views&#39;) Ingestor () {</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">      </span><span class="no">table(&#39;Ingestor&#39;)</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">      </span><span class="no">| project msg = tostring(Body.msg),</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">          </span><span class="no">lvl = tostring(Body.lvl),</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">          </span><span class="no">ts = todatetime(Body.ts),</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">          </span><span class="no">namespace = tostring(Body.namespace),</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">          </span><span class="no">container = tostring(Body.container),</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">          </span><span class="no">pod = tostring(Body.pod),</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">          </span><span class="no">host = tostring(Body.host) </span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">    </span><span class="no">}</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Logs</span>
</code></pre></div>
<p>Naming the View the same as the Table ensures the View takes precedence when queried in ADX. For example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">Ingestor</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="n">ago</span><span class="p">(</span><span class="mi">1</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="p">|</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">lvl</span><span class="w"> </span><span class="p">==</span><span class="w"> </span><span class="s">&#39;ERR&#39;</span>
</code></pre></div>
<p><strong>Note</strong> Only one Kusto View definition is supported per CRD</p>
<h3 id="traces">Traces</h3>
<h3 id="continuous-profiling">Continuous Profiling</h3>
<h3 id="alerts">Alerts</h3>
<p>Alerts are defined through a Kubernetes CRD called <code>AlertRule</code>.  This CRD defines the alerting criteria and the
notification channels that should be used when the alert is triggered.</p>
<p>Alerts are triggered when the alerting criteria is met.  The alerting criteria is defined as a KQL query that is
executed against the ADX cluster.  The query is executed on a schedule and if the query returns any results, the
alert triggers.  Each row of the result translates into an alert notification.</p>
<p>Below is a sample alert on a metric.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nn">---</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">adx-mon.azure.com/v1</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AlertRule</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unique-alert-name</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">alert-namespace</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SomeDatabase</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">  </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="no">let _from=_startTime-1h;</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="no">let _to=_endTime;</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span><span class="no">KubePodContainerStatusWaitingReason</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span><span class="no">| where Timestamp between (_from .. _to)</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">    </span><span class="no">| where ...</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">    </span><span class="no">| extend Container=tostring(Labels.container), Namespace=tostring(Labels.namespace), Pod=tostring(Labels.pod)</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="no">| extend Severity=3</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">    </span><span class="no">| extend Title=&quot;Alert tittle&quot;</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">    </span><span class="no">| extend Summary=&quot;Alert summary details&quot;</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">    </span><span class="no">| extend CorrelationId=&quot;Unique ID to correlate alerts&quot;</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">  </span><span class="nt">autoMitigateAfter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;alerting</span><span class="nv"> </span><span class="s">provider</span><span class="nv"> </span><span class="s">destination&quot;</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">  </span><span class="nt">criteria</span><span class="p">:</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">    </span><span class="nt">cloud</span><span class="p">:</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AzureCloud</span>
</code></pre></div>
<p>All must have the following fields:</p>
<ul>
<li><code>database</code> - The ADX database to execute the query.</li>
<li><code>interval</code> - The interval at which the query should be executed.</li>
<li><code>query</code> - The KQL query to execute.</li>
<li><code>destination</code> - The destination to send the alert to.  This is provider specific.</li>
</ul>
<p>The query must return a table with the following columns:</p>
<ul>
<li><code>Severity</code> - The severity of the alert.  This is used to determine the priority of the alert.</li>
<li><code>Title</code> - The title of the alert.</li>
<li><code>Summary</code> - The summary of the alert.</li>
<li><code>CorrelationId</code> - A unique ID to correlate alerts.  A correlation ID is necessary to prevent duplicate alerts from
being sent to the destination.  If one is not specified, a new alert will be created each interval and it cannot be automitigated. If specified, the <code>CorrelationId</code> will always receive a prefix of <code>${namespace}/${name}://${CorrelationId}</code>.</li>
</ul>
<p>Optionally, the alert definition can define the following fields:</p>
<ul>
<li><code>autoMitigateAfter</code> - The amount of time after the alert is triggered that it should be automatically mitigated if it has not correlated. The automitigiation implementation is dependent on the alert destination implementation.</li>
<li><code>criteria</code> - A list of criteria that must be met for the alert to trigger.  If not specified, the alert will trigger
in all environments.  This is useful for alerts that should only trigger in a specific cloud or region.  The available
criteria options are determined by the <code>alerter</code> tag settings.</li>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>